#!/bin/bash

source config.sh

strainList="${DIR}/data/strainList.tsv"
echo "strain" > "${strainList}"
for sn in "${ALL_STRAIN_NAMES[@]}"
do : 
    echo "${sn}" >> "${strainList}"
done

BDIR="${DIR}/bin"
DDIR="${DIR}/data/downloads"
SDIR="${DIR}/data/straindata"

mkdir -p ${DDIR}
mkdir -p ${SDIR}

function download {
   strain=$1
   fname="${DDIR}/$2"
   url="${BASEURL}/${strain}/$2"
   featFile="${SDIR}/${strain}-features.tsv"
   chrFile="${SDIR}/${strain}-chromosomes.tsv"
   ixFile="${SDIR}/${strain}-index.tsv"
   echo ${strain}
   echo "Downloading:" "${url}" to "${fname}"
   curl -R -z ${fname} -o ${fname} $url
   echo "Generating:" "${featFile}" "${chrFile}" "${ixFile}"
   gunzip -c "${fname}" \
       | grep -v "^#" \
       | grep -v "Parent=" \
       | grep -v biological_region \
       | python "${BDIR}/prepStrainFile.py" -o "${featFile}" -c "${chrFile}"
   python "${BDIR}/indexFeatures.py" -f "${featFile}" -x "${ixFile}" -a create
}


for sn in "${ALL_STRAIN_NAMES[@]}"
do : 
    # For every strain name, there is an env var of that name containing the file name for that strain
    # This gets the file name.
    eval fname=\$$sn
    # call the download function for this pair
    download "${sn}" "${fname}"
    echo ${sn}
done
