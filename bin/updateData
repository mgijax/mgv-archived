#!/bin/bash
#
# Update data
#
# Main script for building/updating the data files used by the viewer.
#

source config.sh

BDIR="${DIR}/bin"
DDIR="${DIR}/data/downloads"
SDIR="${DIR}/data/genomedata"
LOG="${DIR}/data/LOG"

mkdir -p ${DDIR}
mkdir -p ${SDIR}

# generate genome list file (a simple table of genome names and labels)
genomeList="${DIR}/data/genomeList.tsv"
echo "name	label" > "${genomeList}"
count=0
for sn in "${ALL_GENOME_NAMES[@]}"
do : 
    slbl="${ALL_GENOME_LABELS[count]}"
    echo "${sn}	${slbl}" >> "${genomeList}"
    count=$(expr $count + 1)
done

# copy the genomeSets file to the dataDir. This defines named sets of genomes
# and will have cooresponding buttons in the browser for easy selection.
cp "${BDIR}/genomeSets.tsv" "${DIR}/data/genomeSets.tsv"

# generate ENSEMBL to MGI id mapping file
ensemblMappingFile="${DDIR}/ensembl2mgi.tsv"
python "${BDIR}/getEnsemblMgiMapping.py" > "${ensemblMappingFile}"

function download {
   genome=$1
   fname="${DDIR}/$2"
   if [ "$genome" = "mus_musculus_c57bl6j" ]; then
       url="${MGIBASEURL}/$2"
       ismgi="--isMgi"
   else
       url="${BASEURL}/${genome}/$2"
       ismgi="--isNotMgi"
   fi
   featFile="${SDIR}/${genome}-features.tsv"
   chrFile="${SDIR}/${genome}-chromosomes.tsv"
   ixFile="${SDIR}/${genome}-index.tsv"
   #
   echo ${genome}
   echo "Downloading:" "${url}" to "${fname}"
   curl -R -z ${fname} -o ${fname} $url
   #
   echo "Generating:" "${featFile}" "${chrFile}" "${ixFile}"
   gunzip -c "${fname}" \
       | grep -v "^#" \
       | grep -v "Parent=" \
       | grep -v biological_region \
       | sort -k 1,1 -k 4,4n \
       | python "${BDIR}/prepGenomeFile.py" "$ismgi" -m "${ensemblMappingFile}" -o "${featFile}" -c "${chrFile}" 
}

#FIXME: move!
cat ${SDIR}/*features.tsv | grep -v ^chromosome | cut -f 9,10,1-4 | sort -k 5,5 > ${SDIR}/byGenologId.tsv 
sort -k 6,6 ${SDIR}/byGenologId.tsv | grep -v '[.]$' > ${SDIR}/byCanonicalId.tsv

# main loop
for sn in "${ALL_GENOME_NAMES[@]}"
do : 
    # For every genome name, there is an env var of that name containing the file name for that genome
    # This gets the file name.
    eval fname=\$$sn
    # call the download function for this pair
    download "${sn}" "${fname}"
    echo ${sn}
done

./generateBlockFiles


# THE END
