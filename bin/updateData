#!/bin/bash
#
# Update data
#
# Main script for building/updating the data files used by the viewer.
#

source Configuration

function checkerror {
    if [ $? != 0 ]; then
	echo "Caught error. Exiting."
	exit 1
    fi 
}

#
mkdir -p ${WORKINGDIR}

# Copy the genomeSets file to the dataDir. This defines named sets of genomes
# and will have cooresponding buttons in the browser for easy selection.
cp "${BIN}/genomeSets.tsv" "${WORKINGDIR}/genomeSets.tsv"
checkerror

# Generate feature files
${PYTHON} "${BIN}/getDataFromMouseMine.py" --dir "${WORKINGDIR}"
checkerror

# Generate synteny blocks
${PYTHON} "${BIN}/syntenyBlocks.py" --dir "${WORKINGDIR}" > "${WORKINGDIR}/blocks.tsv"
checkerror

# Write timestamp
tsfile="${WORKINGDIR}"/TIMESTAMP.tsv
echo "TIMESTAMP" > "${tsfile}"
checkerror
echo `date` >> "${tsfile}"
checkerror

# Switcheroo
rm -fr "${PREVDIR}"
checkerror
mv -f "${OUTDIR}" "${PREVDIR}"
checkerror
mv -f "${WORKINGDIR}" "${OUTDIR}"
checkerror

# THE END
